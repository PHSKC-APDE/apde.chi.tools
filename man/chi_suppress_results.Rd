% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/chi_suppress_results.R
\name{chi_suppress_results}
\alias{chi_suppress_results}
\title{Suppress data due to small numbers and create a caution flag due to reliability}
\usage{
chi_suppress_results(
  ph.data = NULL,
  suppress_range = c(1, 9),
  secondary = FALSE,
  secondary_ids = c("tab", "indicator_key", "cat1", "cat2_group", "year"),
  secondary_exclude,
  flag_only = FALSE,
  numerator_col = "numerator",
  denominator_col = "denominator",
  rse_col = "rse",
  columns_to_suppress = c("result", "lower_bound", "upper_bound", "se", "rse",
    "numerator", "denominator")
)
}
\arguments{
\item{ph.data}{A data.table or data.frame. Must contain the data to be suppressed
with standard metric names,
i.e., mean, median, sum, rate, lower, upper, se, rse, numerator, denominator,
proportion}

\item{suppress_range}{Integer vector of length 2. They specify the minimum and
maximum range for suppression.}

\item{secondary}{Logical (\code{T}, \code{TRUE}, \code{F}, or \code{FALSE})
indicating whether secondary suppression should be run}

\item{secondary_ids}{Character vector of column names which are used to define
groups for secondary suppression.
Note, this should not include the most granular level. For example, if you wanted
secondary suppression for race/ethnicity within HRAs
where \code{cat1_varname == 'race4'} and \code{cat1_group == 'AIAN'},
\code{cat1_group == 'Asian'}, \code{cat1_group == 'Black'}, etc., you should
have \code{secondary_ids = c('hra20_name', 'cat1_varname')} rather than
\code{secondary_ids = c('hra20_name', 'cat1_varname', 'cat1_group')}}

\item{secondary_exclude}{An unquoted expression that evaluates to a logical vector
indicating which rows to include in secondary suppression analysis. Use this parameter
to exclude categories that are not mutually exclusive (e.g., overlapping demographic
groups). The expression should use column names from the dataset and evaluate to TRUE
for rows to include. For example: `secondary_exclude = cat1_varname != "race3"` would
exclude all rows where cat1_varname equals "race3" from secondary suppression.}

\item{flag_only}{Logical (\code{T}, \code{TRUE}, \code{F}, or \code{FALSE})
indicating whether data to be
suppressed should be flagged without setting estimates to NA}

\item{numerator_col}{Character string with the name of the numerator column. Default is "numerator".}

\item{denominator_col}{Character string with the name of the denominator column. Default is "denominator".}

\item{rse_col}{Character string with the name of the relative standard error column. Default is "rse".}

\item{columns_to_suppress}{Character vector of column names to be suppressed (set to NA) when
suppression is flagged. Default includes common result columns.}
}
\value{
A data.table with suppression applied to CHI standard columns.
}
\description{
This function applies primary data suppression based on the numerator and
denominator and secondary suppression based on the numerator. It also flags
low reliability. Suppressed data are noted by \code{suppression = '^'} and
unreliable data are noted by \code{caution = '!'}.
}
\details{
Data source specific suppression ranges can be found in
\href{https://kc1.sharepoint.com/teams/DPH-APDEData/Shared\%20Documents/General/data_presentation_algorithm/APDE_SmallNumberUpdate.xlsx}{APDE_SmallNumberUpdate.xlsx}


Please review the
\href{https://kc1.sharepoint.com/teams/DPH-APDEData/Shared\%20Documents/General/data_presentation_algorithm/APDEDataPresentationAlgorithm_2020_Approved.pptx}{APDE}
and \href{https://www.doh.wa.gov/Portals/1/Documents/1500/SmallNumbers.pdf}{DOH}
suppression guidelines for details on the logic used in this function.

This function expects data that has already been formatted for CHI. However,
the user can modify the default parameter settings for use with most tables of
summary data.
}
\examples{
\dontrun{
set.seed(98104)
dt <- data.table::data.table(
  chi_year = rep(2018, 100),
  result = rnorm(100, .25, .05),
  numerator = round(rnorm(100, 20, 9), 0),
  denominator = round(rnorm(100, 100, 30), 0),
  rse = sample(1:100, 100, replace = TRUE)
)

# Basic suppression with default parameters
newdt <- chi_suppress_results(ph.data = dt,
                              suppress_range = c(1, 9),
                              secondary = FALSE)

nrow(dt[numerator \%in\% 1:9 | denominator \%in\% 1:9]) # rows needed suppression
nrow(newdt[suppression=='^']) # rows suppressed
nrow(newdt[rse >= 30 | numerator == 0]) # rows needing caution
nrow(newdt[caution=='!']) # rows with caution

# With secondary suppression
dt$region <- sample(c("North", "South", "East", "Seattle"), 100, replace = TRUE)
dt$category <- sample(c("A", "B", "C"), 100, replace = TRUE)

newdt2 <- chi_suppress_results(ph.data = dt,
                               suppress_range = c(1, 9),
                               secondary = TRUE,
                               secondary_ids = c("region", "category"))

nrow(newdt[suppression=='^']) # only primary suppression
nrow(newdt2[suppression=='^']) # with secondary suppression

# Using custom column names
dt2 <- data.table::data.table(
  chi_year = rep(2018, 100),
  mean = rnorm(100, .25, .05),
  num = round(rnorm(100, 20, 9), 0),
  denom = round(rnorm(100, 100, 30), 0),
  rel_se = sample(1:100, 100, replace = TRUE)
)

newdt3 <- chi_suppress_results(ph.data = dt2,
                               suppress_range = c(1, 9),
                               numerator_col = "num",
                               denominator_col = "denom",
                               rse_col = "rel_se",
                               columns_to_suppress = c("mean", "num", "denom"))

nrow(dt2[num \%in\% 1:9 | denom \%in\% 1:9]) # rows need suppression
nrow(newdt3[suppression == '^']) # rows suppressed
}

}
\keyword{suppression}
