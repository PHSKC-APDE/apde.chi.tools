% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/chi_get_proper_pop.R
\name{chi_get_proper_pop}
\alias{chi_get_proper_pop}
\title{Get Population Denominators for CHI Analysis}
\usage{
chi_get_proper_pop(
  pop.template = NULL,
  pop.genders = NULL,
  pop.ages = NULL,
  is_chars = FALSE
)
}
\arguments{
\item{pop.template}{A data.table produced by \code{\link{chi_generate_instructions_pop}},
containing instructions for population data retrieval with the following columns:
 \itemize{
   \item \code{year}: Year range (e.g., "2019-2021" or single year)
   \item \code{cat1}, \code{cat1_varname}: Primary stratification variables
   \item \code{cat2}, \code{cat2_varname}: Secondary stratification variables
   \item \code{tab}: Visualization tab type
   \item \code{start}, \code{stop}: Start and end years parsed from the year range
   \item \code{race_type}: Race categorization type ('race', 'race_eth', or 'race_aic')
   \item \code{geo_type}: Geographic level for analysis ('kc', 'hra', 'region', 'blk', 'zip', 'wa')
   \item \code{group_by1}, group_by2: Race/eth grouping specifications ('race_eth', 'race')
 }}

\item{pop.genders}{Optional character vector specifying which genders to include.
Valid values are \code{'f'}, \code{'female'}, \code{'m'}, \code{'male'}. If NULL (default), both genders are included.}

\item{pop.ages}{Optional integer vector specifying which ages to include.
If \code{NULL} (default), ages 0-100 are included.}

\item{is_chars}{Logical (T|F). If \code{TRUE}, will calculate King County population based
on ZIP codes beginning with 980 or 981, which is necessary for CHARS data.
Default \code{is_chars = FALSE}.}
}
\value{
A data.table containing population counts with columns:
 \itemize{
   \item \code{chi_age}: Single year age
   \item \code{year}: Year
   \item \code{cat1}, cat1_varname, cat1_group: Primary stratification variables
   \item \code{cat2}, cat2_varname, cat2_group: Secondary stratification variables
   \item \code{tab}: Visualization tab type
   \item \code{pop}: Population count
 }
}
\description{
Retrieves population estimates based on instructions generated by
\code{\link{chi_generate_instructions_pop}}. This function processes demographic
categories, geographic levels, and time periods to create appropriate
population denominators for use in CHI rate calculations.
}
\details{
The function:

1. Validates inputs

2. Batches similar population queries based on key parameters

3. Makes minimal database calls to cover all required year ranges

4. Post-processes data in R to match the original template requirements

5. When is_chars=TRUE, uses a different approach for King County that aggregates
   populations from ZIP codes starting with 980/981 instead of using the standard
   King County boundary

For better performance, we recommended using futures for parallel processing. Here is one suggested set up:

\preformatted{
library(future)

options(future.globals.maxSize = 3000 * 1024^2)  # this sets a 3GB limit per future

num.cores <- future::availableCores() - 1 # use one less than the available cores

plan(multisession(workers = num.cores[1])) # set up a multisession plan
}
}
\seealso{
\code{\link{chi_generate_instructions_pop}} which generates the instructions used as input
to this function, \code{\link{chi_get_proper_pop}} the original implementation
}
